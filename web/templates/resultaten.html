{% extends '_base.html' %}

{% block title %}Resultaten{% endblock %}

{% block content %}
<section class="hero mb-4 d-flex justify-content-between align-items-center">
    <div>
        <h1 class="mb-0">Resultaten</h1>
        <p class="page-subtitle mb-0">Historie van gegenereerde XML-bestanden</p>
    </div>
    <div class="d-flex align-items-center gap-2">
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Terug naar Dashboard
        </a>
    </div>
</section>

{% if generated %}
<!-- Move tiles above accordion for better alignment -->
<section class="result-tiles mb-4 app-panel" aria-label="Resultaat samenvatting">
    <div class="chart-tiles-wrapper app-panel">
        <div class="chart-tiles" role="group" aria-label="Snelstatistieken Resultaten">
            <div class="stat-link" role="group" aria-label="Totaal gegenereerd">
                <div class="stat-card uwv-blue chart-tile" aria-live="polite">
                    <div class="stat-icon" aria-hidden="true"><i class="bi bi-file-earmark-text"></i></div>
                    <div class="stat-body">
                        <div class="stat-label">Totaal gegenereerd</div>
                        <div id="res-total-generated" class="stat-value">{{ generated|length if generated is defined else 'Niet beschikbaar' }}</div>
                        <div class="stat-sub">Bestanden</div>
                    </div>
                </div>
            </div>
            <div class="stat-link" role="group" aria-label="Laatste generatie">
                {% set last_status = (generated[0].status if generated and generated|length > 0 and generated[0].status is defined else (generated[0].success is defined and (generated[0].success and 'Geslaagd' or 'Gefaald')) ) %}
                {% set status_class = 'neutral-gray' %}
                {% if last_status == 'Geslaagd' %}
                    {% set status_class = 'uws-success' %}
                {% elif last_status == 'Gefaald' %}
                    {% set status_class = 'uws-danger' %}
                {% endif %}
                <div class="stat-card {{ status_class }} chart-tile" aria-live="polite">
                    <div class="stat-icon" aria-hidden="true"><i class="bi bi-clock"></i></div>
                    <div class="stat-body">
                        <div class="stat-label">Laatste generatie</div>
                        <div id="res-last-status" class="stat-value">{% if generated and generated|length > 0 and generated[0].status %}{{ generated[0].status }}{% else %}Niet beschikbaar{% endif %}</div>
                        <div id="res-last-time" class="stat-sub">{% if generated and generated|length > 0 and generated[0].tijdstip %}{{ generated[0].tijdstip }}{% else %}&nbsp;{% endif %}</div>
                    </div>
                </div>
            </div>
            <div class="stat-link" role="group" aria-label="Totale grootte">
                <div class="stat-card neutral-gray chart-tile" aria-live="polite">
                    <div class="stat-icon" aria-hidden="true"><i class="bi bi-hdd"></i></div>
                    <div class="stat-body">
                        <div class="stat-label">Totale grootte</div>
                        <div id="res-total-size" class="stat-value">{{ (generated|map(attribute='size')|sum) | default('Niet beschikbaar') }} B</div>
                        <div class="stat-sub">Opslag</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="row">
    <div class="col-12">
        <div class="card app-panel resultaten-body">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">Gegenereerde XML-bestanden</h5>
                        <!-- subtitle removed as requested -->
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <a href="{{ url_for('genereer_xml') }}" class="btn btn-sm btn-outline-primary">Genereer XML</a>
                        <button id="download-selected-btn" class="btn btn-sm btn-outline-primary" disabled
                                title="Max {{ zip_limits.max_files }} bestanden per download"
                                data-bs-toggle="tooltip" data-bs-placement="bottom">
                            <span id="zipSpinner" class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true" style="display:none;"></span>
                            <i class="bi bi-download"></i> Download geselecteerd
                        </button>
                    </div>
                </div>

                <div class="mb-3 d-flex justify-content-start align-items-center">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="select-all-generated">
                        <label class="form-check-label small text-muted" for="select-all-generated">Selecteer alles</label>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-7">
                        <div class="generated-list list-group" id="generatedList">
                            {% for file in generated %}
                            {% set status_class = (file.status == 'Geslaagd' or (file.success is defined and file.success)) and 'success' or ((file.status == 'Gefaald' or (file.success is defined and file.success==false)) and 'danger' or 'secondary') %}
                            <div class="list-group-item generated-item d-flex justify-content-between align-items-center" data-filename="{{ file.filename }}">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input generated-select" type="checkbox" id="gen-select-{{ loop.index }}" data-file="{{ file.filename }}">
                                    </div>
                                    <div class="generated-clickable" style="cursor:pointer;">
                                        <div class="fw-bold text-truncate" style="max-width:540px;">{{ file.filename }}</div>
                                        <div class="small text-muted">Aanvraag: {{ file.aanvraag_type or '-' }} — <span class="text-muted">{{ file.tijdstip }}</span></div>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center gap-2">
                                    <div class="text-muted small me-2">{{ (file.size or 0) }} B</div>
                                    <a class="btn btn-sm btn-outline-primary" href="{{ url_for('download_generated', filename=file.filename) }}" title="Download XML bestand"><i class="bi bi-download"></i> Download</a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card border-light bg-light">
                            <div class="card-body" id="previewPane">
                                <h6 class="card-title">Voorvertoning</h6>
                                <div id="previewMeta" class="small text-muted mb-2">Selecteer een bestand om metadata en een preview te zien.</div>
                                <pre id="previewContent" style="max-height:480px; overflow:auto; white-space:pre-wrap; background:#fff; padding:12px; border:1px solid #e9ecef; border-radius:4px;"></pre>
                                <div class="mt-2 d-flex justify-content-end">
                                    <a id="previewDownloadLink" class="btn btn-sm btn-outline-primary" href="#" style="display:none;"><i class="bi bi-download"></i> Download</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
    <div class="text-center py-5">
        <i class="bi bi-inbox fs-1 text-muted d-block mb-3"></i>
        <p class="text-muted">Nog geen gegenereerde XML-bestanden gevonden. Gebruik de <a href="{{ url_for('genereer_xml') }}">Generator</a> om XML te maken.</p>
    </div>
{% endif %}

<script>
// Selection and download handler for generated files list
document.addEventListener('DOMContentLoaded', function () {
    const list = document.getElementById('generatedList');
    const downloadBtn = document.getElementById('download-selected-btn');
    const selectAll = document.getElementById('select-all-generated');
    const previewMeta = document.getElementById('previewMeta');
    const previewContent = document.getElementById('previewContent');
    const previewDownloadLink = document.getElementById('previewDownloadLink');
    const zipSpinner = document.getElementById('zipSpinner');
    const previewSpinner = document.createElement('span');
    previewSpinner.className = 'spinner-border spinner-border-sm me-1';
    previewSpinner.style.display = 'none';
    previewSpinner.setAttribute('role','status');
    previewSpinner.setAttribute('aria-hidden','true');
    // place spinner before previewMeta text
    if (previewMeta) previewMeta.parentNode.insertBefore(previewSpinner, previewMeta);

    function updateSelectionState() {
        const checkboxes = Array.from(document.querySelectorAll('.generated-select'));
        const anyChecked = checkboxes.some(cb => cb.checked);
        downloadBtn.disabled = !anyChecked;
        // mark selected visuals
        checkboxes.forEach(cb => {
            const item = cb.closest('.generated-item');
            if (!item) return;
            if (cb.checked) item.classList.add('selected'); else item.classList.remove('selected');
        });
    }

    if (list) {
        list.addEventListener('change', function (ev) {
            if (ev.target && ev.target.classList.contains('generated-select')) updateSelectionState();
        });
    }

    if (selectAll) {
        selectAll.addEventListener('change', function () {
            const checkboxes = Array.from(document.querySelectorAll('.generated-select'));
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectionState();
        });
    }

    async function downloadSelectedAsZip(filenames) {
        try {
            if (zipSpinner) zipSpinner.style.display = '';
            const resp = await fetch('/resultaten/download-zip', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ filenames: filenames })
            });
            if (!resp.ok) {
                const txt = await resp.text();
                alert('Fout bij maken van ZIP: ' + txt);
                return;
            }
            const blob = await resp.blob();
            let zipName = 'selected_files.zip';
            const cd = resp.headers.get('Content-Disposition');
            if (cd) {
                const m = cd.match(/filename\*=UTF-8''([^;\n\r]+)/) || cd.match(/filename="?([^";]+)"?/);
                if (m && m[1]) zipName = decodeURIComponent(m[1]);
            }
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = zipName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 30000);
            if (zipSpinner) zipSpinner.style.display = 'none';
        } catch (err) {
            if (zipSpinner) zipSpinner.style.display = 'none';
            alert('Fout bij downloaden: ' + err);
        }
    }

    if (downloadBtn) {
        downloadBtn.addEventListener('click', function () {
            const checked = Array.from(document.querySelectorAll('.generated-select:checked'));
            if (checked.length === 0) return;
            const filenames = checked.map(cb => cb.getAttribute('data-file')).filter(Boolean);
            if (filenames.length === 0) return;
            // Use server-side ZIP for bulk download
            downloadSelectedAsZip(filenames);
        });
    }

    // Preview handling: click on item to fetch preview
    if (list) {
        list.addEventListener('click', async function (ev) {
            const target = ev.target;
            const item = target.closest('.generated-item');
            if (!item) return;
            // Ignore clicks on checkboxes or buttons
            if (target.tagName === 'INPUT' || target.closest('a') || target.classList.contains('form-check-input')) return;
            const fn = item.getAttribute('data-filename');
            if (!fn) return;
            try {
                if (previewSpinner) previewSpinner.style.display = '';
                const resp = await fetch('/resultaten/preview/' + encodeURIComponent(fn));
                if (!resp.ok) {
                    previewMeta.textContent = 'Kon preview niet laden.';
                    previewContent.textContent = '';
                    previewDownloadLink.style.display = 'none';
                    if (previewSpinner) previewSpinner.style.display = 'none';
                    return;
                }
                const j = await resp.json();
                previewMeta.textContent = `${j.filename} — ${j.size} B — ${j.tijdstip}`;
                previewContent.textContent = j.preview || '(Leeg)';
                previewDownloadLink.href = '/resultaten/download/' + encodeURIComponent(j.filename);
                previewDownloadLink.style.display = '';
                if (previewSpinner) previewSpinner.style.display = 'none';
            } catch (err) {
                previewMeta.textContent = 'Fout bij laden preview.';
                previewContent.textContent = '';
                previewDownloadLink.style.display = 'none';
                if (previewSpinner) previewSpinner.style.display = 'none';
            }
        });
    }

    // initialize Bootstrap tooltips if Bootstrap JS is loaded
    try {
        if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (el) { new bootstrap.Tooltip(el); });
        }
    } catch (e) {
        // ignore
    }

    // initialize
    updateSelectionState();
});
</script>

{% endblock %}
